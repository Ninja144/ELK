---
- name: Deploy ELK
  hosts: all
  become: yes
  
  vars:
    dest_file: /etc/yum.repos.d/
    dest_config_file: /etc/elasticsearch/elasticsearch.yml

  tasks:

#Install and configure elasticsearch

    - name: Add rpm key
      shell: rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

    - name: Add repo in yum.repos.d
      vars:
        src_file: elasticsearch.repo
      copy: 
        src: "{{ src_file }}"
        dest: "{{ dest_file }}"
    
    - name: Install elastic
      shell: yum install -y elasticsearch

    - name: Copy config
      vars:
        cfg_file: elasticsearch-01.yml
      copy:
        src: "{{ cfg_file }}"
        dest: "{{ dest_config_file }}"
      when: ansible_hostname == "es-node01"

    - name: Copy config
      vars:
        cfg_file: elasticsearch-02.yml
      copy:
        src: "{{ cfg_file }}"
        dest: "{{ dest_config_file }}"
      when: ansible_hostname == "es-node02"

    - name: Copy config
      vars:
        cfg_file: elasticsearch-03.yml
      copy:
        src: "{{ cfg_file }}"
        dest: "{{ dest_config_file }}"
      when: ansible_hostname == "es-node03"

    - name: Start elasticsearch
      service:
        name: elasticsearch
        state: started
        enabled: yes

#    - name: Heap size
#      shell: echo '-Xms16g' >> /etc/elasticsearch/jvm.options; echo '-Xmx16g' >> /etc/elasticsearch/jvm.options

    - name: Disable swapoff
      shell: swapoff -a

    - name: Edit sysctl
      shell: echo "vm.swappiness=1" >> sysctl.conf; sysctl -p

    - name: Restart elasticsearch
      service:
        name: elasticsearch
        state: restarted
        enabled: yes

#Install and configure kibana

    - name: Add rpm key
      shell: sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

    - name: Add repo in /etc/yum.repos.d/
      vars:
        src_file: kibana.repo
      copy:
        src: "{{ src_file }}"
        dest: "{{ dest_file }}"

    - name: Install kibana
      shell: yum install -y kibana

    - name: Started kibana
      service:
        name: kibana
        state: started
        enabled: yes
